<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Journal d'audit des primes</h4>
                </div>
                <div class="card-body">
                    <!-- Filters -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Filtres</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label>Date de début</label>
                                                <md-datepicker ng-model="filters.startDate" md-placeholder="Entrez la date"></md-datepicker>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label>Date de fin</label>
                                                <md-datepicker ng-model="filters.endDate" md-placeholder="Entrez la date"></md-datepicker>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label>Type d'entité</label>
                                                <select class="form-control" ng-model="filters.entityType">
                                                    <option value="">Tous</option>
                                                    <option ng-repeat="type in entityTypes" value="{{type.value}}">{{type.label}}</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label>Action</label>
                                                <select class="form-control" ng-model="filters.action">
                                                    <option value="">Toutes</option>
                                                    <option ng-repeat="action in actionTypes" value="{{action.value}}">{{action.label}}</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label>Utilisateur</label>
                                                <select class="form-control" ng-model="filters.userId">
                                                    <option value="">Tous</option>
                                                    <option ng-repeat="user in users" value="{{user._id}}">{{user.fullName}}</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-12 text-right">
                                            <button class="btn btn-secondary mr-2" ng-click="resetFilters()">
                                                <i class="fa fa-refresh"></i> Réinitialiser
                                            </button>
                                            <button class="btn btn-primary" ng-click="applyFilters()">
                                                <i class="fa fa-search"></i> Appliquer les filtres
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Export button -->
                    <div class="row mb-3">
                        <div class="col-md-12 text-right">
                            <button class="btn btn-success" ng-click="exportToExcel()">
                                <i class="fa fa-file-excel-o"></i> Exporter vers Excel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Loading indicator -->
                    <div ng-if="loading" class="text-center p-5">
                        <i class="fa fa-spinner fa-spin fa-3x"></i>
                        <p class="mt-3">Chargement des journaux d'audit...</p>
                    </div>
                    
                    <!-- Error message -->
                    <div ng-if="error" class="alert alert-danger">
                        <i class="fa fa-exclamation-triangle"></i> {{error}}
                    </div>
                    
                    <!-- Audit logs table -->
                    <div ng-if="!loading && !error">
                        <div ng-if="auditLogs.length === 0" class="alert alert-info">
                            <i class="fa fa-info-circle"></i> Aucun journal d'audit trouvé pour les critères sélectionnés.
                        </div>
                        <div ng-if="auditLogs.length > 0">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Utilisateur</th>
                                        <th>Action</th>
                                        <th>Type d'entité</th>
                                        <th>Entité</th>
                                        <th>Détails</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="log in auditLogs">
                                        <td>{{log.createdAt | date:'dd/MM/yyyy HH:mm:ss'}}</td>
                                        <td>{{log.user ? log.user.fullName : 'Système'}}</td>
                                        <td>
                                            <span ng-if="log.action === 'create'" class="badge badge-success">Création</span>
                                            <span ng-if="log.action === 'update'" class="badge badge-primary">Modification</span>
                                            <span ng-if="log.action === 'delete'" class="badge badge-danger">Suppression</span>
                                            <span ng-if="log.action === 'approve'" class="badge badge-success">Approbation</span>
                                            <span ng-if="log.action === 'reject'" class="badge badge-warning">Rejet</span>
                                            <span ng-if="log.action === 'generate'" class="badge badge-info">Génération</span>
                                            <span ng-if="log.action === 'export'" class="badge badge-secondary">Export</span>
                                        </td>
                                        <td>
                                            <span ng-if="log.entityType === 'template'">Modèle de prime</span>
                                            <span ng-if="log.entityType === 'instance'">Instance de prime</span>
                                            <span ng-if="log.entityType === 'allocation'">Allocation de prime</span>
                                        </td>
                                        <td>
                                            <a ng-if="log.entityType === 'template' && log.entityId" ui-sref="home.bonus.templates.edit({id: log.entityId})">
                                                {{log.entityName || log.entityId}}
                                            </a>
                                            <a ng-if="log.entityType === 'instance' && log.entityId" ui-sref="home.bonus.instances.view({id: log.entityId})">
                                                {{log.entityName || log.entityId}}
                                            </a>
                                            <span ng-if="!log.entityId">{{log.entityName || 'N/A'}}</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info" ng-if="log.changes" 
                                                    ng-click="log.showDetails = !log.showDetails">
                                                <i class="fa" ng-class="{'fa-plus': !log.showDetails, 'fa-minus': log.showDetails}"></i>
                                                {{log.showDetails ? 'Masquer' : 'Afficher'}} les détails
                                            </button>
                                            <span ng-if="!log.changes">Aucun détail</span>
                                            <div ng-if="log.showDetails" class="mt-2">
                                                <div class="card">
                                                    <div class="card-body" ng-bind-html="formatChanges(log.changes)"></div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <!-- Pagination -->
                            <div class="row">
                                <div class="col-md-12 d-flex justify-content-center">
                                    <ul uib-pagination 
                                        total-items="totalItems" 
                                        ng-model="currentPage" 
                                        max-size="5" 
                                        class="pagination-sm" 
                                        boundary-links="true" 
                                        force-ellipses="true" 
                                        items-per-page="itemsPerPage" 
                                        ng-change="pageChanged()">
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
