<div class="modal-header bg-primary py-2">
    <h4 class="modal-title font-weight-semibold text-white">
        <i class="icon-file-plus2 mr-2"></i>
        {{editingTemplate ? 'Edit Bonus Template' : 'Create New Bonus Template'}}
    </h4>
    <button type="button" class="close text-white" ng-click="closeTemplateForm()">Ã—</button>
</div>

<form name="templateForm" ng-submit="templateForm.$valid && saveTemplate()" class="form-validate" novalidate>
    <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
        <!-- Progress Steps -->
        <div class="card mb-3">
            <div class="card-body p-0">
                <div class="progress rounded-0" style="height: 0.375rem;">
                    <div class="progress-bar bg-success" style="width: {{templateForm.$valid ? '100%' : '50%'}}"></div>
                </div>
                <ul class="nav nav-tabs nav-tabs-highlight nav-justified rounded-0 mb-0">
                    <li class="nav-item"><a href="#basic-info" class="nav-link rounded-0 active" data-toggle="tab">Basic Info</a></li>
                    <li class="nav-item"><a href="#calculation" class="nav-link rounded-0" data-toggle="tab">Calculation</a></li>
                    <li class="nav-item"><a href="#rules" class="nav-link rounded-0" data-toggle="tab">Rules</a></li>
                    <li class="nav-item"><a href="#workflow" class="nav-link rounded-0" data-toggle="tab">Workflow</a></li>
                </ul>
            </div>
        </div>

        <div class="tab-content">
            <!-- Basic Info Tab -->
            <div class="tab-pane fade show active" id="basic-info">
                <div class="form-group">
                    <label class="d-flex align-items-center">
                        <i class="icon-barcode2 mr-1"></i>Template Code
                        <span class="text-danger ml-1">*</span>
                        <i class="icon-help ml-1 text-muted"
                           uib-tooltip="Unique identifier for this template. Use uppercase letters, numbers, underscores and dashes only."
                           tooltip-placement="right"></i>
                    </label>
                    <input type="text" name="code" class="form-control"
                           ng-model="templateFormData.code"
                           pattern="[A-Z0-9_-]+" required
                           ng-disabled="editingTemplate"
                           placeholder="e.g., SALES_BONUS_2025">
                    <div class="invalid-feedback" ng-show="templateForm.code.$error.pattern">
                        Code must contain only uppercase letters, numbers, underscores and dashes
                    </div>
                </div>

                <div class="form-group">
                    <label class="d-flex align-items-center">
                        <i class="icon-pencil mr-1"></i>Name
                        <span class="text-danger ml-1">*</span>
                    </label>
                    <input type="text" name="name" class="form-control"
                           ng-model="templateFormData.name" required
                           placeholder="Enter a descriptive name">
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="d-flex align-items-center">
                                <i class="icon-tree5 mr-1"></i>Category
                                <span class="text-danger ml-1">*</span>
                                <i class="icon-help ml-1 text-muted"
                                   uib-tooltip="Determines how the bonus will be calculated"
                                   tooltip-placement="right"></i>
                            </label>
                            <select class="form-control" name="category"
                                    ng-model="templateFormData.category" required>
                                <option value="with_parts">With Parts</option>
                                <option value="without_parts">Without Parts</option>
                                <option value="fixed_amount">Fixed Amount</option>
                                <option value="calculated">Calculated</option>
                            </select>
                            <small class="form-text text-muted">
                                {{getCategoryHelp(templateFormData.category)}}
                            </small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="d-flex align-items-center">
                                <i class="icon-calendar mr-1"></i>Periodicity
                                <span class="text-danger ml-1">*</span>
                            </label>
                            <select class="form-control" name="periodicity"
                                    ng-model="templateFormData.periodicity" required>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="semesterly">Semesterly</option>
                                <option value="yearly">Yearly</option>
                                <option value="on_demand">On Demand</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <i class="icon-file-text2 mr-1"></i>Description
                    </label>
                    <textarea class="form-control" ng-model="templateFormData.description"
                              rows="3" placeholder="Provide a detailed description"></textarea>
                </div>
            </div>

            <!-- Calculation Tab -->
            <div class="tab-pane fade" id="calculation">
                <div class="alert alert-info bg-info-100 border-info">
                    <i class="icon-info22 mr-2"></i>
                    Configure how the bonus amount will be calculated
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="d-flex align-items-center">
                                        Formula Type
                                        <span class="text-danger ml-1">*</span>
                                    </label>
                                    <select class="form-control" name="formulaType"
                                            ng-model="templateFormData.calculationConfig.formulaType" required>
                                        <option value="fixed">Fixed Amount</option>
                                        <option value="percentage">Percentage Based</option>
                                        <option value="custom_formula">Custom Formula</option>
                                        <option value="parts_based">Parts Based</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="d-flex align-items-center">
                                        Base Field
                                        <i class="icon-help ml-1 text-muted"
                                           uib-tooltip="Field to use as calculation base (e.g., salary)"
                                           tooltip-placement="right"></i>
                                    </label>
                                    <input type="text" class="form-control"
                                           ng-model="templateFormData.calculationConfig.baseField"
                                           placeholder="e.g., salary, grade_points">
                                </div>
                            </div>
                        </div>

                        <!-- Default Share Amount Field (Added here) -->
                        <div class="row" ng-if="templateFormData.calculationConfig.formulaType !== 'fixed'">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="d-flex align-items-center">
                                        <i class="icon-coins mr-1"></i>Default Share Amount
                                        <span class="text-danger ml-1">*</span>
                                        <i class="icon-help ml-1 text-muted"
                                           uib-tooltip="Default amount to be used in calculations"
                                           tooltip-placement="right"></i>
                                    </label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">$</span>
                                        </div>
                                        <input type="number" class="form-control" name="defaultShareAmount"
                                               ng-model="templateFormData.calculationConfig.defaultShareAmount"
                                               min="0" required step="0.01"
                                               placeholder="0.00">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Formula Editor -->
                        <div ng-if="templateFormData.calculationConfig.formulaType === 'custom_formula'" class="mt-3">
                            <label class="d-flex align-items-center">
                                <i class="icon-math mr-1"></i>Formula
                                <span class="text-danger ml-1">*</span>
                                <i class="icon-help ml-1 text-muted"
                                   uib-tooltip="Available variables: base, parts, salary, grade_points"
                                   tooltip-placement="right"></i>
                            </label>
                            <div class="formula-editor-container border rounded p-2 bg-light">
                                <textarea class="form-control border-0 bg-transparent" name="formula"
                                          ng-model="templateFormData.calculationConfig.formula"
                                          rows="2" required
                                          placeholder="e.g., base * 0.03 * parts"></textarea>
                            </div>
                            <div class="text-muted mt-1">
                                <small>Use mathematical expressions with available variables</small>
                            </div>
                        </div>

                        <!-- Parts Configuration -->
                        <div ng-if="templateFormData.calculationConfig.formulaType === 'parts_based'" class="mt-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="d-flex align-items-center">
                                            Default Share Amount
                                            <span class="text-danger ml-1">*</span>
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">$</span>
                                            </div>
                                            <input type="number" class="form-control" name="defaultShareAmount"
                                                   ng-model="templateFormData.calculationConfig.defaultShareAmount"
                                                   min="0" required step="0.01"
                                                   placeholder="0.00">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="d-flex align-items-center">
                                            <i class="icon-puzzle3 mr-1"></i>Default Parts
                                            <i class="icon-help ml-1 text-muted"
                                               uib-tooltip="Default number of parts if no rules match"
                                               tooltip-placement="right"></i>
                                        </label>
                                        <input type="number" class="form-control"
                                               ng-model="templateFormData.calculationConfig.partsConfig.defaultParts"
                                               min="1" value="1">
                                    </div>
                                </div>
                            </div>

                            <!-- Parts Rules -->
                            <div class="card border-0 shadow-sm mt-3">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h6 class="card-title mb-0">
                                        <i class="icon-list-numbered mr-1"></i>Parts Rules
                                    </h6>
                                    <button type="button" class="btn btn-sm btn-primary" ng-click="addPartRule()">
                                        <i class="icon-plus22 mr-1"></i>Add Rule
                                    </button>
                                </div>

                                <div class="card-body">
                                    <div class="alert alert-warning bg-warning-100 border-warning" ng-if="!templateFormData.calculationConfig.partsConfig.partRules.length">
                                        No parts rules defined. The default parts will be used for all calculations.
                                    </div>

                                    <div class="parts-rule mb-3 p-3 border rounded"
                                         ng-repeat="rule in templateFormData.calculationConfig.partsConfig.partRules track by $index">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="badge badge-primary mr-2">Rule {{$index + 1}}</div>
                                            <button type="button" class="btn btn-sm btn-link text-danger ml-auto"
                                                    ng-click="removePartRule($index)">
                                                <i class="icon-cross2"></i> Remove
                                            </button>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>Condition</label>
                                                    <input type="text" class="form-control" ng-model="rule.condition"
                                                           placeholder="Condition (e.g., grade === 'A')"
                                                           uib-tooltip="JavaScript condition that evaluates to true/false"
                                                           tooltip-placement="top">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Parts</label>
                                                    <input type="number" class="form-control" ng-model="rule.parts"
                                                           min="0" placeholder="Parts">
                                                </div>
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                <div class="form-group w-100">
                                                    <button type="button" class="btn btn-light btn-block"
                                                            ng-click="moveRuleUp($index)" ng-if="$index > 0">
                                                        <i class="icon-arrow-up2"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-light btn-block"
                                                            ng-click="moveRuleDown($index)"
                                                            ng-if="$index < templateFormData.calculationConfig.partsConfig.partRules.length - 1">
                                                        <i class="icon-arrow-down2"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rules Tab -->
            <div class="tab-pane fade" id="rules">
                <div class="alert alert-info bg-info-100 border-info">
                    <i class="icon-info22 mr-2"></i>
                    Define eligibility rules to determine who can receive this bonus
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="icon-shield-check mr-1"></i>Eligibility Rules
                        </h6>
                        <button type="button" class="btn btn-sm btn-primary" ng-click="addEligibilityRule()">
                            <i class="icon-plus22 mr-1"></i>Add Rule
                        </button>
                    </div>

                    <div class="card-body">
                        <div class="alert alert-warning bg-warning-100 border-warning" ng-if="!templateFormData.eligibilityRules.length">
                            No eligibility rules defined. This bonus will be available to all personnel.
                        </div>

                        <div class="eligibility-rule mb-3 p-3 border rounded"
                             ng-repeat="rule in templateFormData.eligibilityRules track by $index">
                            <div class="d-flex align-items-center mb-2">
                                <div class="badge badge-primary mr-2">Rule {{$index + 1}}</div>
                                <button type="button" class="btn btn-sm btn-link text-danger ml-auto"
                                        ng-click="removeEligibilityRule($index)">
                                    <i class="icon-cross2"></i> Remove
                                </button>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Field</label>
                                        <input type="text" class="form-control" ng-model="rule.field"
                                               placeholder="Field name" required
                                               uib-tooltip="Personnel field to check"
                                               tooltip-placement="top">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Operator</label>
                                        <select class="form-control" ng-model="rule.operator" required>
                                            <option value="equals">Equals</option>
                                            <option value="not_equals">Not Equals</option>
                                            <option value="contains">Contains</option>
                                            <option value="greater_than">Greater Than</option>
                                            <option value="less_than">Less Than</option>
                                            <option value="in">In</option>
                                            <option value="not_in">Not In</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Value</label>
                                        <input type="text" class="form-control" ng-model="rule.value"
                                               placeholder="Value" required>
                                    </div>
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <div class="form-group w-100">
                                        <button type="button" class="btn btn-light btn-block"
                                                ng-click="moveRuleUp($index)" ng-if="$index > 0">
                                            <i class="icon-arrow-up2"></i>
                                        </button>
                                        <button type="button" class="btn btn-light btn-block"
                                                ng-click="moveRuleDown($index)"
                                                ng-if="$index < templateFormData.eligibilityRules.length - 1">
                                            <i class="icon-arrow-down2"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mt-2">
                                <label>Description (Optional)</label>
                                <input type="text" class="form-control" ng-model="rule.description"
                                       placeholder="Rule description">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workflow Tab -->
            <div class="tab-pane fade" id="workflow">
                <div class="alert alert-info bg-info-100 border-info">
                    <i class="icon-info22 mr-2"></i>
                    Configure the approval workflow for this bonus template
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="icon-flow-tree mr-1"></i>Approval Steps
                        </h6>
                        <button type="button" class="btn btn-sm btn-primary" ng-click="addApprovalStep()">
                            <i class="icon-plus22 mr-1"></i>Add Step
                        </button>
                    </div>

                    <div class="card-body">
                        <div class="alert alert-warning bg-warning-100 border-warning" ng-if="!templateFormData.approvalWorkflow.steps.length">
                            No approval steps defined. Bonuses using this template will not require approval.
                        </div>

                        <div class="workflow-step mb-3 p-3 border rounded"
                             ng-repeat="step in templateFormData.approvalWorkflow.steps track by $index">
                            <div class="d-flex align-items-center mb-2">
                                <div class="badge badge-primary mr-2">Step {{$index + 1}}</div>
                                <button type="button" class="btn btn-sm btn-link text-danger ml-auto"
                                        ng-click="removeApprovalStep($index)">
                                    <i class="icon-cross2"></i> Remove
                                </button>
                            </div>
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group">
                                        <label>Approver Role</label>
                                        <input type="text" class="form-control" ng-model="step.role"
                                               placeholder="Role" required
                                               uib-tooltip="Role required for approval"
                                               tooltip-placement="top">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Approval Type</label>
                                        <select class="form-control" ng-model="step.approvalType">
                                            <option value="sequential">Sequential</option>
                                            <option value="parallel">Parallel</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Description</label>
                                        <input type="text" class="form-control" ng-model="step.description"
                                               placeholder="Step description">
                                    </div>
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <div class="form-group w-100">
                                        <button type="button" class="btn btn-light btn-block"
                                                ng-click="moveStepUp($index)" ng-if="$index > 0">
                                            <i class="icon-arrow-up2"></i>
                                        </button>
                                        <button type="button" class="btn btn-light btn-block"
                                                ng-click="moveStepDown($index)"
                                                ng-if="$index < templateFormData.approvalWorkflow.steps.length - 1">
                                            <i class="icon-arrow-down2"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documentation -->
                <div class="form-group mt-4">
                    <label class="d-flex align-items-center">
                        <i class="icon-book mr-1"></i>Instructions
                        <i class="icon-help ml-1 text-muted"
                           uib-tooltip="Markdown formatting is supported"
                           tooltip-placement="right"></i>
                    </label>
                    <div class="border rounded p-2 bg-light">
                        <textarea class="form-control border-0 bg-transparent" ng-model="templateFormData.documentation"
                                  rows="4" placeholder="Enter documentation or instructions..."></textarea>
                    </div>
                </div>

                <!-- Status -->
                <div class="form-group mt-4">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="templateActive"
                               ng-model="templateFormData.isActive">
                        <label class="custom-control-label" for="templateActive">
                            <i class="icon-power mr-1"></i>Template is active
                        </label>
                    </div>
                    <small class="form-text text-muted">
                        Inactive templates cannot be used to create new bonuses
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-footer bg-light d-flex justify-content-between">
        <div>
            <button type="button" class="btn btn-light" ng-click="closeTemplateForm()">
                <i class="icon-cross2 mr-1"></i>Cancel
            </button>
        </div>
        <div>
            <button type="submit" class="btn btn-primary" ng-disabled="templateForm.$invalid">
                <i class="icon-paperplane mr-1"></i>
                {{editingTemplate ? 'Update Template' : 'Create Template'}}
            </button>
        </div>
    </div>
</form>